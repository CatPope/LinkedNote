"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const node_path_1 = __importDefault(require("node:path"));
const debug_1 = __importDefault(require("debug"));
const html_webpack_plugin_1 = __importDefault(require("html-webpack-plugin"));
const webpack_1 = __importDefault(require("webpack"));
const webpack_merge_1 = require("webpack-merge");
const AssetRelocatorPatch_1 = __importDefault(require("./util/AssetRelocatorPatch"));
const processConfig_1 = __importDefault(require("./util/processConfig"));
const rendererTypeUtils_1 = require("./util/rendererTypeUtils");
const d = (0, debug_1.default)('electron-forge:plugin:webpack:webpackconfig');
var RendererTarget;
(function (RendererTarget) {
    RendererTarget[RendererTarget["Web"] = 0] = "Web";
    RendererTarget[RendererTarget["ElectronRenderer"] = 1] = "ElectronRenderer";
    RendererTarget[RendererTarget["ElectronPreload"] = 2] = "ElectronPreload";
    RendererTarget[RendererTarget["SandboxedPreload"] = 3] = "SandboxedPreload";
})(RendererTarget || (RendererTarget = {}));
var WebpackTarget;
(function (WebpackTarget) {
    WebpackTarget["Web"] = "web";
    WebpackTarget["ElectronPreload"] = "electron-preload";
    WebpackTarget["ElectronRenderer"] = "electron-renderer";
})(WebpackTarget || (WebpackTarget = {}));
function isNotNull(item) {
    return item !== null;
}
function rendererTargetToWebpackTarget(target) {
    switch (target) {
        case RendererTarget.Web:
        case RendererTarget.SandboxedPreload:
            return WebpackTarget.Web;
        case RendererTarget.ElectronPreload:
            return WebpackTarget.ElectronPreload;
        case RendererTarget.ElectronRenderer:
            return WebpackTarget.ElectronRenderer;
    }
}
class WebpackConfigGenerator {
    constructor(pluginConfig, projectDir, isProd, port) {
        // Users can override this method in a subclass to provide custom logic or
        // configuration parameters.
        this.preprocessConfig = async (config) => config({}, {
            mode: this.mode,
        });
        this.pluginConfig = pluginConfig;
        this.projectDir = projectDir;
        this.webpackDir = node_path_1.default.resolve(projectDir, '.webpack');
        this.isProd = isProd;
        this.port = port;
        d('Config mode:', this.mode);
    }
    async resolveConfig(config) {
        let rawConfig = typeof config === 'string'
            ? // eslint-disable-next-line @typescript-eslint/no-require-imports
                require(node_path_1.default.resolve(this.projectDir, config))
            : config;
        if (rawConfig && typeof rawConfig === 'object' && 'default' in rawConfig) {
            rawConfig = rawConfig.default;
        }
        return (0, processConfig_1.default)(this.preprocessConfig, rawConfig);
    }
    get mode() {
        return this.isProd ? 'production' : 'development';
    }
    get rendererSourceMapOption() {
        return this.isProd ? 'source-map' : 'eval-source-map';
    }
    rendererEntryPoint(entryPoint, basename) {
        if (this.isProd) {
            return `\`file://$\{require('path').resolve(__dirname, '..', 'renderer', '${entryPoint.name}', '${basename}')}\``;
        }
        const protocol = this.pluginConfig.devServer?.server === 'https' ? 'https' : 'http';
        const baseUrl = `${protocol}://localhost:${this.port}/${entryPoint.name}`;
        return `'${baseUrl}/${basename}'`;
    }
    toEnvironmentVariable(entryPoint, preload = false) {
        const suffix = preload ? '_PRELOAD_WEBPACK_ENTRY' : '_WEBPACK_ENTRY';
        return `${entryPoint.name.toUpperCase().replace(/ /g, '_')}${suffix}`;
    }
    getPreloadDefine(entryPoint) {
        if (!(0, rendererTypeUtils_1.isNoWindow)(entryPoint)) {
            if (this.isProd) {
                return `require('path').resolve(__dirname, '../renderer', '${entryPoint.name}', 'preload.js')`;
            }
            return `'${node_path_1.default.resolve(this.webpackDir, 'renderer', entryPoint.name, 'preload.js').replace(/\\/g, '\\\\')}'`;
        }
        else {
            // If this entry-point has no configured preload script just map this constant to `undefined`
            // so that any code using it still works.  This makes quick-start / docs simpler.
            return 'undefined';
        }
    }
    get allPluginRendererOptions() {
        return Array.isArray(this.pluginConfig.renderer) ? this.pluginConfig.renderer : [this.pluginConfig.renderer];
    }
    getDefines() {
        const defines = {};
        for (const pluginRendererOptions of this.allPluginRendererOptions) {
            if (!pluginRendererOptions.entryPoints || !Array.isArray(pluginRendererOptions.entryPoints)) {
                throw new Error('Required config option "renderer.entryPoints" has not been defined');
            }
            for (const entryPoint of pluginRendererOptions.entryPoints) {
                const entryKey = this.toEnvironmentVariable(entryPoint);
                if ((0, rendererTypeUtils_1.isLocalWindow)(entryPoint)) {
                    defines[entryKey] = this.rendererEntryPoint(entryPoint, 'index.html');
                }
                else {
                    defines[entryKey] = this.rendererEntryPoint(entryPoint, 'index.js');
                }
                defines[`process.env.${entryKey}`] = defines[entryKey];
                const preloadDefineKey = this.toEnvironmentVariable(entryPoint, true);
                defines[preloadDefineKey] = this.getPreloadDefine(entryPoint);
                defines[`process.env.${preloadDefineKey}`] = defines[preloadDefineKey];
            }
        }
        return defines;
    }
    async getMainConfig() {
        const mainConfig = await this.resolveConfig(this.pluginConfig.mainConfig);
        if (!mainConfig.entry) {
            throw new Error('Required option "mainConfig.entry" has not been defined');
        }
        const fix = (item) => {
            if (typeof item === 'string')
                return fix([item])[0];
            if (Array.isArray(item)) {
                return item.map((val) => (val.startsWith('./') ? node_path_1.default.resolve(this.projectDir, val) : val));
            }
            const ret = {};
            for (const key of Object.keys(item)) {
                ret[key] = fix(item[key]);
            }
            return ret;
        };
        mainConfig.entry = fix(mainConfig.entry);
        return (0, webpack_merge_1.merge)({
            devtool: 'source-map',
            target: 'electron-main',
            mode: this.mode,
            output: {
                path: node_path_1.default.resolve(this.webpackDir, 'main'),
                filename: 'index.js',
                libraryTarget: 'commonjs2',
            },
            plugins: [new webpack_1.default.DefinePlugin(this.getDefines())],
            node: {
                __dirname: false,
                __filename: false,
            },
        }, mainConfig || {});
    }
    async getRendererConfig(rendererOptions) {
        const entryPointsForTarget = {
            web: [],
            electronRenderer: [],
            electronPreload: [],
            sandboxedPreload: [],
        };
        for (const entry of rendererOptions.entryPoints) {
            const target = entry.nodeIntegration ?? rendererOptions.nodeIntegration ? 'electronRenderer' : 'web';
            const preloadTarget = entry.nodeIntegration ?? rendererOptions.nodeIntegration ? 'electronPreload' : 'sandboxedPreload';
            if ((0, rendererTypeUtils_1.isPreloadOnly)(entry)) {
                entryPointsForTarget[preloadTarget].push(entry);
            }
            else {
                entryPointsForTarget[target].push(entry);
                if ((0, rendererTypeUtils_1.isLocalWindow)(entry) && entry.preload) {
                    entryPointsForTarget[preloadTarget].push({ ...entry, preload: entry.preload });
                }
            }
        }
        const rendererConfigs = await Promise.all([
            await this.buildRendererConfigs(rendererOptions, entryPointsForTarget.web, RendererTarget.Web),
            await this.buildRendererConfigs(rendererOptions, entryPointsForTarget.electronRenderer, RendererTarget.ElectronRenderer),
            await this.buildRendererConfigs(rendererOptions, entryPointsForTarget.electronPreload, RendererTarget.ElectronPreload),
            await this.buildRendererConfigs(rendererOptions, entryPointsForTarget.sandboxedPreload, RendererTarget.SandboxedPreload),
        ].reduce((configs, allConfigs) => allConfigs.concat(configs)));
        return rendererConfigs.filter(isNotNull);
    }
    buildRendererBaseConfig(target) {
        return {
            target: rendererTargetToWebpackTarget(target),
            devtool: this.rendererSourceMapOption,
            mode: this.mode,
            output: {
                path: node_path_1.default.resolve(this.webpackDir, 'renderer'),
                filename: '[name]/index.js',
                globalObject: 'self',
                ...(this.isProd ? {} : { publicPath: '/' }),
            },
            node: {
                __dirname: false,
                __filename: false,
            },
            plugins: [new AssetRelocatorPatch_1.default(this.isProd, target === RendererTarget.ElectronRenderer || target === RendererTarget.ElectronPreload)],
        };
    }
    async buildRendererConfigForWebOrRendererTarget(rendererOptions, entryPoints, target) {
        if (!(0, rendererTypeUtils_1.isLocalOrNoWindowEntries)(entryPoints)) {
            throw new Error('Invalid renderer entry point detected.');
        }
        const entry = {};
        const baseConfig = this.buildRendererBaseConfig(target);
        const rendererConfig = await this.resolveConfig(rendererOptions.config);
        const output = {
            path: node_path_1.default.resolve(this.webpackDir, 'renderer'),
            filename: '[name]/index.js',
            globalObject: 'self',
            ...(this.isProd ? {} : { publicPath: '/' }),
        };
        const plugins = [];
        for (const entryPoint of entryPoints) {
            entry[entryPoint.name] = (entryPoint.prefixedEntries || []).concat([entryPoint.js]);
            if ((0, rendererTypeUtils_1.isLocalWindow)(entryPoint)) {
                plugins.push(new html_webpack_plugin_1.default({
                    title: entryPoint.name,
                    template: entryPoint.html,
                    filename: `${entryPoint.name}/index.html`,
                    chunks: [entryPoint.name].concat(entryPoint.additionalChunks || []),
                }));
            }
        }
        return (0, webpack_merge_1.merge)(baseConfig, rendererConfig || {}, { entry, output, plugins });
    }
    async buildRendererConfigForPreloadOrSandboxedPreloadTarget(rendererOptions, entryPoints, target) {
        if (entryPoints.length === 0) {
            return null;
        }
        const externals = ['electron', 'electron/renderer', 'electron/common', 'events', 'timers', 'url'];
        const entry = {};
        const baseConfig = this.buildRendererBaseConfig(target);
        const rendererConfig = await this.resolveConfig(entryPoints[0].preload?.config || rendererOptions.config);
        for (const entryPoint of entryPoints) {
            entry[entryPoint.name] = (entryPoint.prefixedEntries || []).concat([entryPoint.preload.js]);
        }
        const config = {
            target: rendererTargetToWebpackTarget(target),
            entry,
            output: {
                path: node_path_1.default.resolve(this.webpackDir, 'renderer'),
                filename: '[name]/preload.js',
                globalObject: 'self',
                ...(this.isProd ? { publicPath: '' } : { publicPath: '/' }),
            },
            plugins: target === RendererTarget.ElectronPreload ? [] : [new webpack_1.default.ExternalsPlugin('commonjs2', externals)],
        };
        return (0, webpack_merge_1.merge)(baseConfig, rendererConfig || {}, config);
    }
    async buildRendererConfigs(rendererOptions, entryPoints, target) {
        if (entryPoints.length === 0) {
            return [];
        }
        const rendererConfigs = [];
        if (target === RendererTarget.Web || target === RendererTarget.ElectronRenderer) {
            rendererConfigs.push(this.buildRendererConfigForWebOrRendererTarget(rendererOptions, entryPoints, target));
            return rendererConfigs;
        }
        else if (target === RendererTarget.ElectronPreload || target === RendererTarget.SandboxedPreload) {
            if (!(0, rendererTypeUtils_1.isPreloadOnlyEntries)(entryPoints)) {
                throw new Error('Invalid renderer entry point detected.');
            }
            const entryPointsWithPreloadConfig = [], entryPointsWithoutPreloadConfig = [];
            entryPoints.forEach((entryPoint) => (entryPoint.preload.config ? entryPointsWithPreloadConfig : entryPointsWithoutPreloadConfig).push(entryPoint));
            rendererConfigs.push(this.buildRendererConfigForPreloadOrSandboxedPreloadTarget(rendererOptions, entryPointsWithoutPreloadConfig, target));
            entryPointsWithPreloadConfig.forEach((entryPoint) => {
                rendererConfigs.push(this.buildRendererConfigForPreloadOrSandboxedPreloadTarget(rendererOptions, [entryPoint], target));
            });
            return rendererConfigs;
        }
        else {
            throw new Error('Invalid renderer entry point detected.');
        }
    }
}
exports.default = WebpackConfigGenerator;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiV2VicGFja0NvbmZpZy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9XZWJwYWNrQ29uZmlnLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsMERBQTZCO0FBRTdCLGtEQUEwQjtBQUMxQiw4RUFBb0Q7QUFDcEQsc0RBQXdFO0FBQ3hFLGlEQUFzRDtBQVN0RCxxRkFBNkQ7QUFDN0QseUVBQWlEO0FBQ2pELGdFQUFvSTtBQUtwSSxNQUFNLENBQUMsR0FBRyxJQUFBLGVBQUssRUFBQyw2Q0FBNkMsQ0FBQyxDQUFDO0FBTy9ELElBQUssY0FLSjtBQUxELFdBQUssY0FBYztJQUNqQixpREFBRyxDQUFBO0lBQ0gsMkVBQWdCLENBQUE7SUFDaEIseUVBQWUsQ0FBQTtJQUNmLDJFQUFnQixDQUFBO0FBQ2xCLENBQUMsRUFMSSxjQUFjLEtBQWQsY0FBYyxRQUtsQjtBQUVELElBQUssYUFJSjtBQUpELFdBQUssYUFBYTtJQUNoQiw0QkFBVyxDQUFBO0lBQ1gscURBQW9DLENBQUE7SUFDcEMsdURBQXNDLENBQUE7QUFDeEMsQ0FBQyxFQUpJLGFBQWEsS0FBYixhQUFhLFFBSWpCO0FBRUQsU0FBUyxTQUFTLENBQUksSUFBYztJQUNsQyxPQUFPLElBQUksS0FBSyxJQUFJLENBQUM7QUFDdkIsQ0FBQztBQUVELFNBQVMsNkJBQTZCLENBQUMsTUFBc0I7SUFDM0QsUUFBUSxNQUFNLEVBQUUsQ0FBQztRQUNmLEtBQUssY0FBYyxDQUFDLEdBQUcsQ0FBQztRQUN4QixLQUFLLGNBQWMsQ0FBQyxnQkFBZ0I7WUFDbEMsT0FBTyxhQUFhLENBQUMsR0FBRyxDQUFDO1FBQzNCLEtBQUssY0FBYyxDQUFDLGVBQWU7WUFDakMsT0FBTyxhQUFhLENBQUMsZUFBZSxDQUFDO1FBQ3ZDLEtBQUssY0FBYyxDQUFDLGdCQUFnQjtZQUNsQyxPQUFPLGFBQWEsQ0FBQyxnQkFBZ0IsQ0FBQztJQUMxQyxDQUFDO0FBQ0gsQ0FBQztBQUVELE1BQXFCLHNCQUFzQjtJQVd6QyxZQUFZLFlBQWlDLEVBQUUsVUFBa0IsRUFBRSxNQUFlLEVBQUUsSUFBWTtRQTBCaEcsMEVBQTBFO1FBQzFFLDRCQUE0QjtRQUM1QixxQkFBZ0IsR0FBRyxLQUFLLEVBQUUsTUFBNEIsRUFBMEIsRUFBRSxDQUNoRixNQUFNLENBQ0osRUFBRSxFQUNGO1lBQ0UsSUFBSSxFQUFFLElBQUksQ0FBQyxJQUFJO1NBQ2hCLENBQ0YsQ0FBQztRQWpDRixJQUFJLENBQUMsWUFBWSxHQUFHLFlBQVksQ0FBQztRQUNqQyxJQUFJLENBQUMsVUFBVSxHQUFHLFVBQVUsQ0FBQztRQUM3QixJQUFJLENBQUMsVUFBVSxHQUFHLG1CQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsRUFBRSxVQUFVLENBQUMsQ0FBQztRQUN2RCxJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztRQUNyQixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztRQUVqQixDQUFDLENBQUMsY0FBYyxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUMvQixDQUFDO0lBRUQsS0FBSyxDQUFDLGFBQWEsQ0FBQyxNQUFxRDtRQUd2RSxJQUFJLFNBQVMsR0FDWCxPQUFPLE1BQU0sS0FBSyxRQUFRO1lBQ3hCLENBQUMsQ0FBQyxpRUFBaUU7Z0JBQ2hFLE9BQU8sQ0FBQyxtQkFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLE1BQU0sQ0FBQyxDQUFvRDtZQUNwRyxDQUFDLENBQUMsTUFBTSxDQUFDO1FBRWIsSUFBSSxTQUFTLElBQUksT0FBTyxTQUFTLEtBQUssUUFBUSxJQUFJLFNBQVMsSUFBSSxTQUFTLEVBQUUsQ0FBQztZQUN6RSxTQUFTLEdBQUcsU0FBUyxDQUFDLE9BQU8sQ0FBQztRQUNoQyxDQUFDO1FBRUQsT0FBTyxJQUFBLHVCQUFhLEVBQUMsSUFBSSxDQUFDLGdCQUFnQixFQUFFLFNBQVMsQ0FBQyxDQUFDO0lBQ3pELENBQUM7SUFZRCxJQUFJLElBQUk7UUFDTixPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsYUFBYSxDQUFDO0lBQ3BELENBQUM7SUFFRCxJQUFJLHVCQUF1QjtRQUN6QixPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsaUJBQWlCLENBQUM7SUFDeEQsQ0FBQztJQUVELGtCQUFrQixDQUFDLFVBQW1DLEVBQUUsUUFBZ0I7UUFDdEUsSUFBSSxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7WUFDaEIsT0FBTyxxRUFBcUUsVUFBVSxDQUFDLElBQUksT0FBTyxRQUFRLE9BQU8sQ0FBQztRQUNwSCxDQUFDO1FBQ0QsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxTQUFTLEVBQUUsTUFBTSxLQUFLLE9BQU8sQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUM7UUFDcEYsTUFBTSxPQUFPLEdBQUcsR0FBRyxRQUFRLGdCQUFnQixJQUFJLENBQUMsSUFBSSxJQUFJLFVBQVUsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUMxRSxPQUFPLElBQUksT0FBTyxJQUFJLFFBQVEsR0FBRyxDQUFDO0lBQ3BDLENBQUM7SUFFRCxxQkFBcUIsQ0FBQyxVQUFtQyxFQUFFLE9BQU8sR0FBRyxLQUFLO1FBQ3hFLE1BQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxDQUFDLENBQUMsd0JBQXdCLENBQUMsQ0FBQyxDQUFDLGdCQUFnQixDQUFDO1FBQ3JFLE9BQU8sR0FBRyxVQUFVLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDLEdBQUcsTUFBTSxFQUFFLENBQUM7SUFDeEUsQ0FBQztJQUVELGdCQUFnQixDQUFDLFVBQW1DO1FBQ2xELElBQUksQ0FBQyxJQUFBLDhCQUFVLEVBQUMsVUFBVSxDQUFDLEVBQUUsQ0FBQztZQUM1QixJQUFJLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztnQkFDaEIsT0FBTyxzREFBc0QsVUFBVSxDQUFDLElBQUksa0JBQWtCLENBQUM7WUFDakcsQ0FBQztZQUNELE9BQU8sSUFBSSxtQkFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLFVBQVUsRUFBRSxVQUFVLENBQUMsSUFBSSxFQUFFLFlBQVksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsTUFBTSxDQUFDLEdBQUcsQ0FBQztRQUNoSCxDQUFDO2FBQU0sQ0FBQztZQUNOLDZGQUE2RjtZQUM3RixpRkFBaUY7WUFDakYsT0FBTyxXQUFXLENBQUM7UUFDckIsQ0FBQztJQUNILENBQUM7SUFFRCxJQUFZLHdCQUF3QjtRQUNsQyxPQUFPLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUMvRyxDQUFDO0lBRUQsVUFBVTtRQUNSLE1BQU0sT0FBTyxHQUEyQixFQUFFLENBQUM7UUFFM0MsS0FBSyxNQUFNLHFCQUFxQixJQUFJLElBQUksQ0FBQyx3QkFBd0IsRUFBRSxDQUFDO1lBQ2xFLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxXQUFXLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLHFCQUFxQixDQUFDLFdBQVcsQ0FBQyxFQUFFLENBQUM7Z0JBQzVGLE1BQU0sSUFBSSxLQUFLLENBQUMsb0VBQW9FLENBQUMsQ0FBQztZQUN4RixDQUFDO1lBQ0QsS0FBSyxNQUFNLFVBQVUsSUFBSSxxQkFBcUIsQ0FBQyxXQUFXLEVBQUUsQ0FBQztnQkFDM0QsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLHFCQUFxQixDQUFDLFVBQVUsQ0FBQyxDQUFDO2dCQUN4RCxJQUFJLElBQUEsaUNBQWEsRUFBQyxVQUFVLENBQUMsRUFBRSxDQUFDO29CQUM5QixPQUFPLENBQUMsUUFBUSxDQUFDLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixDQUFDLFVBQVUsRUFBRSxZQUFZLENBQUMsQ0FBQztnQkFDeEUsQ0FBQztxQkFBTSxDQUFDO29CQUNOLE9BQU8sQ0FBQyxRQUFRLENBQUMsR0FBRyxJQUFJLENBQUMsa0JBQWtCLENBQUMsVUFBVSxFQUFFLFVBQVUsQ0FBQyxDQUFDO2dCQUN0RSxDQUFDO2dCQUNELE9BQU8sQ0FBQyxlQUFlLFFBQVEsRUFBRSxDQUFDLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO2dCQUV2RCxNQUFNLGdCQUFnQixHQUFHLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxVQUFVLEVBQUUsSUFBSSxDQUFDLENBQUM7Z0JBQ3RFLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxVQUFVLENBQUMsQ0FBQztnQkFDOUQsT0FBTyxDQUFDLGVBQWUsZ0JBQWdCLEVBQUUsQ0FBQyxHQUFHLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1lBQ3pFLENBQUM7UUFDSCxDQUFDO1FBRUQsT0FBTyxPQUFPLENBQUM7SUFDakIsQ0FBQztJQUVELEtBQUssQ0FBQyxhQUFhO1FBQ2pCLE1BQU0sVUFBVSxHQUFHLE1BQU0sSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBRTFFLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxFQUFFLENBQUM7WUFDdEIsTUFBTSxJQUFJLEtBQUssQ0FBQyx5REFBeUQsQ0FBQyxDQUFDO1FBQzdFLENBQUM7UUFDRCxNQUFNLEdBQUcsR0FBRyxDQUFDLElBQWUsRUFBYSxFQUFFO1lBQ3pDLElBQUksT0FBTyxJQUFJLEtBQUssUUFBUTtnQkFBRSxPQUFRLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFjLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDbEUsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUM7Z0JBQ3hCLE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxtQkFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQzlGLENBQUM7WUFDRCxNQUFNLEdBQUcsR0FBc0MsRUFBRSxDQUFDO1lBQ2xELEtBQUssTUFBTSxHQUFHLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDO2dCQUNwQyxHQUFHLENBQUMsR0FBRyxDQUFDLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBc0IsQ0FBQztZQUNqRCxDQUFDO1lBQ0QsT0FBTyxHQUFHLENBQUM7UUFDYixDQUFDLENBQUM7UUFDRixVQUFVLENBQUMsS0FBSyxHQUFHLEdBQUcsQ0FBQyxVQUFVLENBQUMsS0FBa0IsQ0FBQyxDQUFDO1FBRXRELE9BQU8sSUFBQSxxQkFBWSxFQUNqQjtZQUNFLE9BQU8sRUFBRSxZQUFZO1lBQ3JCLE1BQU0sRUFBRSxlQUFlO1lBQ3ZCLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSTtZQUNmLE1BQU0sRUFBRTtnQkFDTixJQUFJLEVBQUUsbUJBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxNQUFNLENBQUM7Z0JBQzNDLFFBQVEsRUFBRSxVQUFVO2dCQUNwQixhQUFhLEVBQUUsV0FBVzthQUMzQjtZQUNELE9BQU8sRUFBRSxDQUFDLElBQUksaUJBQU8sQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDLENBQUM7WUFDdEQsSUFBSSxFQUFFO2dCQUNKLFNBQVMsRUFBRSxLQUFLO2dCQUNoQixVQUFVLEVBQUUsS0FBSzthQUNsQjtTQUNGLEVBQ0QsVUFBVSxJQUFJLEVBQUUsQ0FDakIsQ0FBQztJQUNKLENBQUM7SUFFRCxLQUFLLENBQUMsaUJBQWlCLENBQUMsZUFBNEM7UUFDbEUsTUFBTSxvQkFBb0IsR0FBRztZQUMzQixHQUFHLEVBQUUsRUFBc0U7WUFDM0UsZ0JBQWdCLEVBQUUsRUFBc0U7WUFDeEYsZUFBZSxFQUFFLEVBQTBDO1lBQzNELGdCQUFnQixFQUFFLEVBQTBDO1NBQzdELENBQUM7UUFFRixLQUFLLE1BQU0sS0FBSyxJQUFJLGVBQWUsQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUNoRCxNQUFNLE1BQU0sR0FBRyxLQUFLLENBQUMsZUFBZSxJQUFJLGVBQWUsQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDLGtCQUFrQixDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUM7WUFDckcsTUFBTSxhQUFhLEdBQUcsS0FBSyxDQUFDLGVBQWUsSUFBSSxlQUFlLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLENBQUMsa0JBQWtCLENBQUM7WUFFeEgsSUFBSSxJQUFBLGlDQUFhLEVBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQztnQkFDekIsb0JBQW9CLENBQUMsYUFBYSxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ2xELENBQUM7aUJBQU0sQ0FBQztnQkFDTixvQkFBb0IsQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7Z0JBQ3pDLElBQUksSUFBQSxpQ0FBYSxFQUFDLEtBQUssQ0FBQyxJQUFJLEtBQUssQ0FBQyxPQUFPLEVBQUUsQ0FBQztvQkFDMUMsb0JBQW9CLENBQUMsYUFBYSxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsR0FBRyxLQUFLLEVBQUUsT0FBTyxFQUFFLEtBQUssQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDO2dCQUNqRixDQUFDO1lBQ0gsQ0FBQztRQUNILENBQUM7UUFFRCxNQUFNLGVBQWUsR0FBRyxNQUFNLE9BQU8sQ0FBQyxHQUFHLENBQ3ZDO1lBQ0UsTUFBTSxJQUFJLENBQUMsb0JBQW9CLENBQUMsZUFBZSxFQUFFLG9CQUFvQixDQUFDLEdBQUcsRUFBRSxjQUFjLENBQUMsR0FBRyxDQUFDO1lBQzlGLE1BQU0sSUFBSSxDQUFDLG9CQUFvQixDQUFDLGVBQWUsRUFBRSxvQkFBb0IsQ0FBQyxnQkFBZ0IsRUFBRSxjQUFjLENBQUMsZ0JBQWdCLENBQUM7WUFDeEgsTUFBTSxJQUFJLENBQUMsb0JBQW9CLENBQUMsZUFBZSxFQUFFLG9CQUFvQixDQUFDLGVBQWUsRUFBRSxjQUFjLENBQUMsZUFBZSxDQUFDO1lBQ3RILE1BQU0sSUFBSSxDQUFDLG9CQUFvQixDQUFDLGVBQWUsRUFBRSxvQkFBb0IsQ0FBQyxnQkFBZ0IsRUFBRSxjQUFjLENBQUMsZ0JBQWdCLENBQUM7U0FDekgsQ0FBQyxNQUFNLENBQUMsQ0FBQyxPQUFPLEVBQUUsVUFBVSxFQUFFLEVBQUUsQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQzlELENBQUM7UUFFRixPQUFPLGVBQWUsQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDM0MsQ0FBQztJQUVELHVCQUF1QixDQUFDLE1BQXNCO1FBQzVDLE9BQU87WUFDTCxNQUFNLEVBQUUsNkJBQTZCLENBQUMsTUFBTSxDQUFDO1lBQzdDLE9BQU8sRUFBRSxJQUFJLENBQUMsdUJBQXVCO1lBQ3JDLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSTtZQUNmLE1BQU0sRUFBRTtnQkFDTixJQUFJLEVBQUUsbUJBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxVQUFVLENBQUM7Z0JBQy9DLFFBQVEsRUFBRSxpQkFBaUI7Z0JBQzNCLFlBQVksRUFBRSxNQUFNO2dCQUNwQixHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLFVBQVUsRUFBRSxHQUFHLEVBQUUsQ0FBQzthQUM1QztZQUNELElBQUksRUFBRTtnQkFDSixTQUFTLEVBQUUsS0FBSztnQkFDaEIsVUFBVSxFQUFFLEtBQUs7YUFDbEI7WUFDRCxPQUFPLEVBQUUsQ0FBQyxJQUFJLDZCQUFtQixDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsTUFBTSxLQUFLLGNBQWMsQ0FBQyxnQkFBZ0IsSUFBSSxNQUFNLEtBQUssY0FBYyxDQUFDLGVBQWUsQ0FBQyxDQUFDO1NBQ3pJLENBQUM7SUFDSixDQUFDO0lBRUQsS0FBSyxDQUFDLHlDQUF5QyxDQUM3QyxlQUE0QyxFQUM1QyxXQUFzQyxFQUN0QyxNQUE0RDtRQUU1RCxJQUFJLENBQUMsSUFBQSw0Q0FBd0IsRUFBQyxXQUFXLENBQUMsRUFBRSxDQUFDO1lBQzNDLE1BQU0sSUFBSSxLQUFLLENBQUMsd0NBQXdDLENBQUMsQ0FBQztRQUM1RCxDQUFDO1FBRUQsTUFBTSxLQUFLLEdBQWtCLEVBQUUsQ0FBQztRQUNoQyxNQUFNLFVBQVUsR0FBMEIsSUFBSSxDQUFDLHVCQUF1QixDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQy9FLE1BQU0sY0FBYyxHQUFHLE1BQU0sSUFBSSxDQUFDLGFBQWEsQ0FBQyxlQUFlLENBQUMsTUFBTSxDQUFDLENBQUM7UUFFeEUsTUFBTSxNQUFNLEdBQUc7WUFDYixJQUFJLEVBQUUsbUJBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxVQUFVLENBQUM7WUFDL0MsUUFBUSxFQUFFLGlCQUFpQjtZQUMzQixZQUFZLEVBQUUsTUFBTTtZQUNwQixHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLFVBQVUsRUFBRSxHQUFHLEVBQUUsQ0FBQztTQUM1QyxDQUFDO1FBQ0YsTUFBTSxPQUFPLEdBQW9DLEVBQUUsQ0FBQztRQUVwRCxLQUFLLE1BQU0sVUFBVSxJQUFJLFdBQVcsRUFBRSxDQUFDO1lBQ3JDLEtBQUssQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsZUFBZSxJQUFJLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBRXBGLElBQUksSUFBQSxpQ0FBYSxFQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUM7Z0JBQzlCLE9BQU8sQ0FBQyxJQUFJLENBQ1YsSUFBSSw2QkFBaUIsQ0FBQztvQkFDcEIsS0FBSyxFQUFFLFVBQVUsQ0FBQyxJQUFJO29CQUN0QixRQUFRLEVBQUUsVUFBVSxDQUFDLElBQUk7b0JBQ3pCLFFBQVEsRUFBRSxHQUFHLFVBQVUsQ0FBQyxJQUFJLGFBQWE7b0JBQ3pDLE1BQU0sRUFBRSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLGdCQUFnQixJQUFJLEVBQUUsQ0FBQztpQkFDcEUsQ0FBMEIsQ0FDNUIsQ0FBQztZQUNKLENBQUM7UUFDSCxDQUFDO1FBQ0QsT0FBTyxJQUFBLHFCQUFZLEVBQUMsVUFBVSxFQUFFLGNBQWMsSUFBSSxFQUFFLEVBQUUsRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxDQUFDLENBQUM7SUFDcEYsQ0FBQztJQUVELEtBQUssQ0FBQyxxREFBcUQsQ0FDekQsZUFBNEMsRUFDNUMsV0FBaUQsRUFDakQsTUFBd0U7UUFFeEUsSUFBSSxXQUFXLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRSxDQUFDO1lBQzdCLE9BQU8sSUFBSSxDQUFDO1FBQ2QsQ0FBQztRQUVELE1BQU0sU0FBUyxHQUFHLENBQUMsVUFBVSxFQUFFLG1CQUFtQixFQUFFLGlCQUFpQixFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFFbEcsTUFBTSxLQUFLLEdBQWtCLEVBQUUsQ0FBQztRQUNoQyxNQUFNLFVBQVUsR0FBMEIsSUFBSSxDQUFDLHVCQUF1QixDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQy9FLE1BQU0sY0FBYyxHQUFHLE1BQU0sSUFBSSxDQUFDLGFBQWEsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxFQUFFLE1BQU0sSUFBSSxlQUFlLENBQUMsTUFBTSxDQUFDLENBQUM7UUFFMUcsS0FBSyxNQUFNLFVBQVUsSUFBSSxXQUFXLEVBQUUsQ0FBQztZQUNyQyxLQUFLLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLGVBQWUsSUFBSSxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDOUYsQ0FBQztRQUNELE1BQU0sTUFBTSxHQUFrQjtZQUM1QixNQUFNLEVBQUUsNkJBQTZCLENBQUMsTUFBTSxDQUFDO1lBQzdDLEtBQUs7WUFDTCxNQUFNLEVBQUU7Z0JBQ04sSUFBSSxFQUFFLG1CQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsVUFBVSxDQUFDO2dCQUMvQyxRQUFRLEVBQUUsbUJBQW1CO2dCQUM3QixZQUFZLEVBQUUsTUFBTTtnQkFDcEIsR0FBRyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsVUFBVSxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLFVBQVUsRUFBRSxHQUFHLEVBQUUsQ0FBQzthQUM1RDtZQUNELE9BQU8sRUFBRSxNQUFNLEtBQUssY0FBYyxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksaUJBQU8sQ0FBQyxlQUFlLENBQUMsV0FBVyxFQUFFLFNBQVMsQ0FBQyxDQUFDO1NBQ2hILENBQUM7UUFDRixPQUFPLElBQUEscUJBQVksRUFBQyxVQUFVLEVBQUUsY0FBYyxJQUFJLEVBQUUsRUFBRSxNQUFNLENBQUMsQ0FBQztJQUNoRSxDQUFDO0lBRUQsS0FBSyxDQUFDLG9CQUFvQixDQUN4QixlQUE0QyxFQUM1QyxXQUFzQyxFQUN0QyxNQUFzQjtRQUV0QixJQUFJLFdBQVcsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFLENBQUM7WUFDN0IsT0FBTyxFQUFFLENBQUM7UUFDWixDQUFDO1FBQ0QsTUFBTSxlQUFlLEdBQUcsRUFBRSxDQUFDO1FBQzNCLElBQUksTUFBTSxLQUFLLGNBQWMsQ0FBQyxHQUFHLElBQUksTUFBTSxLQUFLLGNBQWMsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1lBQ2hGLGVBQWUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLHlDQUF5QyxDQUFDLGVBQWUsRUFBRSxXQUFXLEVBQUUsTUFBTSxDQUFDLENBQUMsQ0FBQztZQUMzRyxPQUFPLGVBQWUsQ0FBQztRQUN6QixDQUFDO2FBQU0sSUFBSSxNQUFNLEtBQUssY0FBYyxDQUFDLGVBQWUsSUFBSSxNQUFNLEtBQUssY0FBYyxDQUFDLGdCQUFnQixFQUFFLENBQUM7WUFDbkcsSUFBSSxDQUFDLElBQUEsd0NBQW9CLEVBQUMsV0FBVyxDQUFDLEVBQUUsQ0FBQztnQkFDdkMsTUFBTSxJQUFJLEtBQUssQ0FBQyx3Q0FBd0MsQ0FBQyxDQUFDO1lBQzVELENBQUM7WUFFRCxNQUFNLDRCQUE0QixHQUF5QyxFQUFFLEVBQzNFLCtCQUErQixHQUF5QyxFQUFFLENBQUM7WUFDN0UsV0FBVyxDQUFDLE9BQU8sQ0FBQyxDQUFDLFVBQVUsRUFBRSxFQUFFLENBQUMsQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsNEJBQTRCLENBQUMsQ0FBQyxDQUFDLCtCQUErQixDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUM7WUFFbkosZUFBZSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMscURBQXFELENBQUMsZUFBZSxFQUFFLCtCQUErQixFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUM7WUFDM0ksNEJBQTRCLENBQUMsT0FBTyxDQUFDLENBQUMsVUFBVSxFQUFFLEVBQUU7Z0JBQ2xELGVBQWUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLHFEQUFxRCxDQUFDLGVBQWUsRUFBRSxDQUFDLFVBQVUsQ0FBQyxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUM7WUFDMUgsQ0FBQyxDQUFDLENBQUM7WUFDSCxPQUFPLGVBQWUsQ0FBQztRQUN6QixDQUFDO2FBQU0sQ0FBQztZQUNOLE1BQU0sSUFBSSxLQUFLLENBQUMsd0NBQXdDLENBQUMsQ0FBQztRQUM1RCxDQUFDO0lBQ0gsQ0FBQztDQUNGO0FBL1NELHlDQStTQyJ9